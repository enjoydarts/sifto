name: Deploy

on:
  push:
    branches:
      - main

jobs:
  migrate:
    name: Run DB migrations
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install golang-migrate
        run: |
          curl -L https://github.com/golang-migrate/migrate/releases/download/v4.18.1/migrate.linux-amd64.tar.gz | tar xz
          sudo mv migrate /usr/local/bin/migrate

      - name: Run migrations
        env:
          MIGRATE_DATABASE_URL: ${{ secrets.MIGRATE_DATABASE_URL }}
        run: |
          VERSION_OUTPUT=$(migrate -path db/migrations -database "$MIGRATE_DATABASE_URL" version 2>&1 || true)
          if echo "$VERSION_OUTPUT" | grep -q "dirty"; then
            DIRTY_VERSION=$(echo "$VERSION_OUTPUT" | grep -o '^[0-9]*')
            PREV=$((DIRTY_VERSION - 1))
            echo "Dirty version $DIRTY_VERSION detected, forcing to $PREV"
            migrate -path db/migrations -database "$MIGRATE_DATABASE_URL" force $PREV
          fi
          migrate -path db/migrations -database "$MIGRATE_DATABASE_URL" up

  deploy-api:
    name: Deploy API to Fly.io
    needs: migrate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy API
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: flyctl deploy --remote-only
        working-directory: api

  deploy-worker:
    name: Deploy Worker to Fly.io
    needs: migrate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy Worker
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: flyctl deploy --remote-only
        working-directory: worker

  deploy-web:
    name: Deploy Web to Vercel
    needs: migrate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Vercel CLI
        run: npm i -g vercel

      - name: Deploy Web
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: vercel deploy --prod --token "$VERCEL_TOKEN"
