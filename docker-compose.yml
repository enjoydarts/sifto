services:
  postgres:
    image: postgres:16
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      TZ: ${TZ}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./db/migrations:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U sifto"]
      interval: 5s
      timeout: 5s
      retries: 5

  api:
    build:
      context: ./api
      target: dev
    ports:
      - "8081:8080"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
    environment:
      DATABASE_URL: ${DOCKER_DATABASE_URL}
      PYTHON_WORKER_URL: ${DOCKER_PYTHON_WORKER_URL}
      INTERNAL_WORKER_SECRET: ${INTERNAL_WORKER_SECRET}
      REDIS_URL: ${DOCKER_REDIS_URL:-redis://redis:6379/0}
      TZ: ${TZ}
      INNGEST_DEV: ${INNGEST_DEV}
      ALLOW_DEV_AUTH_BYPASS: ${ALLOW_DEV_AUTH_BYPASS}
      DEV_AUTH_USER_ID: ${DEV_AUTH_USER_ID}
      INNGEST_EVENT_KEY: ${INNGEST_EVENT_KEY}
      INNGEST_SIGNING_KEY: ${INNGEST_SIGNING_KEY}
      INNGEST_BASE_URL: ${DOCKER_INNGEST_BASE_URL}
      NEXTAUTH_SECRET: ${NEXTAUTH_SECRET}
      USER_SECRET_ENCRYPTION_KEY: ${USER_SECRET_ENCRYPTION_KEY}
    env_file:
      - .env
    volumes:
      - ./api:/app

  worker:
    build: ./worker
    ports:
      - "8000:8000"
    command: ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload", "--reload-dir", "/app/app"]
    environment:
      ANTHROPIC_FACTS_MODEL: ${ANTHROPIC_FACTS_MODEL}
      ANTHROPIC_FACTS_MODEL_FALLBACK: ${ANTHROPIC_FACTS_MODEL_FALLBACK}
      ANTHROPIC_SUMMARY_MODEL: ${ANTHROPIC_SUMMARY_MODEL}
      ANTHROPIC_SUMMARY_MODEL_FALLBACK: ${ANTHROPIC_SUMMARY_MODEL_FALLBACK}
      ANTHROPIC_DIGEST_MODEL: ${ANTHROPIC_DIGEST_MODEL}
      ANTHROPIC_DIGEST_MODEL_FALLBACK: ${ANTHROPIC_DIGEST_MODEL_FALLBACK}
      INTERNAL_WORKER_SECRET: ${INTERNAL_WORKER_SECRET}
      TZ: ${TZ}
      ALLOW_DEV_EXTRACT_PLACEHOLDER: ${ALLOW_DEV_EXTRACT_PLACEHOLDER}
    env_file:
      - .env
    volumes:
      - ./worker:/app

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

  inngest:
    image: inngest/inngest:latest
    ports:
      - "8288:8288"
    command: ["inngest", "dev", "-u", "${INNGEST_DEV_UPSTREAM_URL}"]

  web:
    build:
      context: ./web
      target: dev
    ports:
      - "3000:3000"
    volumes:
      - ./web:/app
      - web_node_modules:/app/node_modules
    environment:
      NEXT_PUBLIC_API_URL: http://api:8080
      NEXT_PUBLIC_ALLOW_DEV_AUTH_BYPASS: ${ALLOW_DEV_AUTH_BYPASS}
      NEXT_PUBLIC_GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      NEXTAUTH_URL: http://localhost:3000
      NEXTAUTH_SECRET: ${NEXTAUTH_SECRET}
      ALLOW_DEV_AUTH_BYPASS: ${ALLOW_DEV_AUTH_BYPASS}
      DEV_AUTH_USER_ID: ${DEV_AUTH_USER_ID}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
    depends_on:
      - api

volumes:
  postgres_data:
  web_node_modules:
